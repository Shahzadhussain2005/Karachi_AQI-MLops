name: Daily Model Retraining

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  retrain:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install
      run: pip install pandas numpy scikit-learn xgboost lightgbm pymongo dnspython requests meteostat
    
    - name: Train (Fast)
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
      run: |
        python - <<'EOF'
        import pandas as pd
        import numpy as np
        import pickle
        import json
        import os
        from sklearn.preprocessing import RobustScaler
        import xgboost as xgb
        import lightgbm as lgb
        
        print("Loading data...")
        df = pd.read_csv('data/cleaned_aqi_data_v2.csv')
        df['time'] = pd.to_datetime(df['time'])
        df = df.sort_values('time').tail(2000)  # Last 2000 rows only
        
        print("Preparing features...")
        numeric_df = df.select_dtypes(include=[np.number]).fillna(0)
        
        # Targets
        numeric_df['y24'] = numeric_df['aqi'].shift(-24)
        numeric_df['y48'] = numeric_df['aqi'].shift(-48)
        numeric_df['y72'] = numeric_df['aqi'].shift(-72)
        numeric_df = numeric_df.dropna(subset=['y24','y48','y72'])
        
        X = numeric_df.drop(['y24','y48','y72'], axis=1)
        y24, y48, y72 = numeric_df['y24'], numeric_df['y48'], numeric_df['y72']
        
        print(f"Data: {len(X)} rows, {len(X.columns)} features")
        
        # Split
        split = int(len(X)*0.8)
        X_train, X_test = X[:split], X[split:]
        y24_train, y24_test = y24[:split], y24[split:]
        y48_train, y48_test = y48[:split], y48[split:]
        y72_train, y72_test = y72[:split], y72[split:]
        
        # Scale
        scaler = RobustScaler()
        X_train = scaler.fit_transform(X_train)
        X_test = scaler.transform(X_test)
        
        os.makedirs('models', exist_ok=True)
        
        # Train FAST models 
        for horizon, y_tr, y_te in [('24h',y24_train,y24_test), ('48h',y48_train,y48_test), ('72h',y72_train,y72_test)]:
            print(f"Training {horizon}...")
            
            # XGBoost - FAST settings
            xgb_model = xgb.XGBRegressor(
                n_estimators=50,      # Reduced from 100
                max_depth=3,          # Reduced from 5
                learning_rate=0.1,
                random_state=42,
                n_jobs=-1
            )
            xgb_model.fit(X_train, y_tr)
            xgb_score = xgb_model.score(X_test, y_te)
            
            # LightGBM - FAST settings
            lgb_model = lgb.LGBMRegressor(
                n_estimators=50,
                max_depth=3,
                learning_rate=0.1,
                random_state=42,
                verbose=-1,
                n_jobs=-1
            )
            lgb_model.fit(X_train, y_tr)
            lgb_score = lgb_model.score(X_test, y_te)
            
            # Use best
            if xgb_score > lgb_score:
                best_model, best_name, best_score = xgb_model, 'xgboost', xgb_score
            else:
                best_model, best_name, best_score = lgb_model, 'lightgbm', lgb_score
            
            with open(f'models/{best_name}_{horizon}.pkl', 'wb') as f:
                pickle.dump(best_model, f)
            
            print(f"  {best_name}: RÂ²={best_score:.3f}")
        
        # Save scaler and features
        with open('models/scaler_ml.pkl', 'wb') as f:
            pickle.dump(scaler, f)
        
        with open('models/feature_names.json', 'w') as f:
            json.dump(list(X.columns), f)
        
        print(f"Done! Saved {scaler.n_features_in_} features")
        EOF
    
    - name: Verify models
      run: |
        echo "Models created:"
        ls -lh models/*.pkl
    
    - name: Commit
      run: |
        git config user.email "actions@github.com"
        git config user.name "Actions Bot"
        git add models/
        git diff --staged --quiet || {
          git commit -m "ðŸ¤– Retrain $(date +'%Y-%m-%d')"
          git push
        }
    
    - name: Summary
      if: always()
      run: |
        echo "=== Summary ==="
        ls models/*.pkl 2>/dev/null | wc -l | xargs echo "Models:"
        du -sh models/ 2>/dev/null || echo "No models"
