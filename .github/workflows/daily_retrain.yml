name: Daily Model Retraining

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes for testing, change to '0 0 * * *' after success
  workflow_dispatch:

jobs:
  retrain:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install packages
      run: pip install jupyter nbconvert pandas numpy scikit-learn xgboost lightgbm pymongo "pymongo[srv]" dnspython requests meteostat

    - name: Fetch data
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
      run: |
        jupyter nbconvert --to python Scripts/Fetch_latest_data.ipynb --output /tmp/fetch --ExecutePreprocessor.timeout=600
        python /tmp/fetch.py || true
      continue-on-error: true

    - name: Clean data
      run: |
        jupyter nbconvert --to python Scripts/clean_data.ipynb --output /tmp/clean --ExecutePreprocessor.timeout=600
        python /tmp/clean.py || true
      continue-on-error: true

    - name: Train models (simplified)
      run: |
        python - <<'EOF'
        import pandas as pd
        import numpy as np
        from sklearn.ensemble import GradientBoostingRegressor
        from sklearn.preprocessing import StandardScaler
        import xgboost as xgb
        import lightgbm as lgb
        import pickle, os
        
        df = pd.read_csv('data/cleaned_aqi_data_v2.csv')
        df = df.select_dtypes(include=[np.number]).dropna()
        
        X = df.drop(['aqi'], axis=1, errors='ignore').tail(1000)
        y_24h = df['aqi'].shift(-24).dropna().tail(1000)
        X = X.iloc[:len(y_24h)]
        
        split = int(len(X)*0.8)
        X_train, X_test = X[:split], X[split:]
        y_train, y_test = y_24h[:split], y_24h[split:]
        
        scaler = StandardScaler()
        X_train = scaler.fit_transform(X_train)
        X_test = scaler.transform(X_test)
        
        os.makedirs('models', exist_ok=True)
        
        for name, model in [
            ('xgboost', xgb.XGBRegressor(n_estimators=50, max_depth=3, random_state=42)),
            ('lightgbm', lgb.LGBMRegressor(n_estimators=50, max_depth=3, random_state=42, verbose=-1))
        ]:
            model.fit(X_train, y_train)
            with open(f'models/{name}_24h.pkl', 'wb') as f:
                pickle.dump(model, f)
            print(f"âœ“ Trained {name}")
        
        with open('models/scaler_ml.pkl', 'wb') as f:
            pickle.dump(scaler, f)
        print("âœ“ Models saved")
        EOF

    - name: Commit
      run: |
        git config user.email "actions@github.com"
        git config user.name "Actions"
        git add models/ data/ || true
        git diff --staged --quiet || {
          git commit -m "ðŸ¤– Retrain: $(date +'%Y-%m-%d %H:%M')"
          git push
        }
